name: Slack Notifications (Issues/PRs/Releases)

on:
  workflow_dispatch:
    inputs:
      test_message:
        description: 'Send a test message to Slack'
        required: false
        default: 'Manual test from workflow_dispatch'
  issues:
    types: [opened, edited, closed, reopened]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, ready_for_review, review_requested, closed, reopened, converted_to_draft, synchronize]
  release:
    types: [published]

permissions:
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    
    env:
      CH_ISSUES:   ${{ secrets.SLACK_CH_ISSUES }}
      CH_PRS:      ${{ secrets.SLACK_CH_PRS }}
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
        
      - name: Build Slack payload (Block Kit)
        id: payload
        env:
          EVENT_PATH: ${{ github.event_path }}
          GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          TEST_MESSAGE: ${{ inputs.test_message }}
          RUN_ID: ${{ github.run_id }}
        run: |
          set -euo pipefail
          # ê³µí†µ ì»¨í…ìŠ¤íŠ¸ ì¶”ì¶œ
          DATE=$(date +%Y-%m-%d)
          REPO="$(jq -r '.repository.full_name' "$EVENT_PATH")"
          ACTOR="${GITHUB_ACTOR}"
          EVENT_NAME="${GITHUB_EVENT_NAME}"
          ACTION="$(jq -r '.action // empty' "$EVENT_PATH")"

          # URL/ì œëª©/ë³¸ë¬¸/ë²ˆí˜¸/ë¨¸ì§€ì—¬ë¶€ ë“± ì¶”ì¶œ
          URL=$(jq -r '.issue.html_url // .pull_request.html_url // .release.html_url // .comment.html_url // .repository.html_url' "$EVENT_PATH")
          NUMBER=$(jq -r '.issue.number // .pull_request.number // empty' "$EVENT_PATH")
          TITLE_RAW=$(jq -r '.issue.title // .pull_request.title // .release.name // empty' "$EVENT_PATH")
          BODY_RAW=$(jq -r '.issue.body // .pull_request.body // .release.body // .comment.body // empty' "$EVENT_PATH")
          BODY_TRUNC=$(printf "%s" "$BODY_RAW" | head -c 500)

          MERGED=$(jq -r '.pull_request.merged // false' "$EVENT_PATH")

          # ì´ë²¤íŠ¸ â†’ ì±„ë„ ë¼ìš°íŒ…
          CHANNEL=""
          case "${EVENT_NAME}" in
            issues|issue_comment) CHANNEL="${CH_ISSUES}";;
            pull_request)         CHANNEL="${CH_PRS}";;
          esac
          
          # ì´ë²¤íŠ¸ë³„ íƒ€ì´í‹€/ì´ëª¨ì§€/ìƒ‰ìƒ
          TITLE=""
          COLOR="#dddddd"
          case "${EVENT_NAME}/${ACTION}" in
            issues/opened)              TITLE="ğŸ’¡ ì´ìŠˆ ì—´ë¦¼" ; COLOR="#36a64f" ;;
            issues/closed)              TITLE="âœ… ì´ìŠˆ ë‹«í˜" ; COLOR="#aaaaaa" ;;
            issues/reopened)            TITLE="ğŸ”„ ì´ìŠˆ ë‹¤ì‹œ ì—´ë¦¼" ; COLOR="#e3b341" ;;
            pull_request/opened)        TITLE="ğŸ“£ í’€ ë¦¬í€˜ìŠ¤íŠ¸ ìš”ì²­" ; COLOR="#439FE0" ;;
            pull_request/ready_for_review) TITLE="ğŸš€ í’€ ë¦¬í€˜ìŠ¤íŠ¸ ë¦¬ë·° ì¤€ë¹„" ; COLOR="#439FE0" ;;
            pull_request/converted_to_draft) TITLE="ğŸ“ í’€ ë¦¬í€˜ìŠ¤íŠ¸ ì´ˆì•ˆìœ¼ë¡œ ë³€ê²½" ; COLOR="#aaaaaa" ;;
            pull_request/closed)
              if [ "$MERGED" = "true" ]; then
                TITLE="ğŸ‰ í’€ ë¦¬í€˜ìŠ¤íŠ¸ ë¨¸ì§€ë¨" ; COLOR="#6f42c1"
              else
                TITLE="â›”ï¸ í’€ ë¦¬í€˜ìŠ¤íŠ¸ ì·¨ì†Œ" ; COLOR="#aaaaaa"
              fi
              ;;
            pull_request/synchronize)   TITLE="ğŸ”„ í’€ ë¦¬í€˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸" ; COLOR="#439FE0" ;;
            release/published)          TITLE="ğŸ·ï¸ ë¦´ë¦¬ì¦ˆ ë°°í¬" ; COLOR="#2eb67d" ;;
            issue_comment/created)      TITLE="ğŸ’¬ ìƒˆë¡œìš´ ëŒ“ê¸€" ; COLOR="#4a154b" ;;
            */)
              # workflow_dispatch ë“±
              TITLE="â„¹ï¸ GitHub notification"
              ;;
            *)
              TITLE="â„¹ï¸ ${EVENT_NAME} (${ACTION})"
              ;;
          esac

          # ìˆ˜ë™ ì‹¤í–‰ ì‹œ í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì§€ì›
          if [ "${EVENT_NAME}" = "workflow_dispatch" ]; then
            BODY_TRUNC="${TEST_MESSAGE}"
            URL="https://github.com/${{ github.repository }}"
          fi

          # ë³¸ë¬¸ ì—†ìœ¼ë©´ ëŒ€ì²´ë¬¸êµ¬
          if [ -z "${BODY_TRUNC}" ]; then
            BODY_TRUNC="(no description)"
          fi

          # â”€â”€ GitHub MD â†’ Slack mrkdwn ë³€í™˜ â”€â”€
          BODY_SLACK="$BODY_TRUNC"
          
          # 1) ì²´í¬ë¦¬ìŠ¤íŠ¸: - [x] / - [ ]  â†’ â€¢ :white_check_mark: / â€¢ :white_large_square:
          BODY_SLACK=$(printf "%s" "$BODY_SLACK" | sed -E 's/^[[:space:]]*[-*][[:space:]]+\[[xX]\][[:space:]]+(.+)$/â€¢ :white_check_mark: \1/g')
          BODY_SLACK=$(printf "%s" "$BODY_SLACK" | sed -E 's/^[[:space:]]*[-*][[:space:]]+\[[[:space:]]*\][[:space:]]+(.+)$/â€¢ :white_large_square: \1/g')
          
          # 2) ì¼ë°˜ ë¦¬ìŠ¤íŠ¸: - item / * item â†’ â€¢ item
          BODY_SLACK=$(printf "%s" "$BODY_SLACK" | sed -E 's/^[[:space:]]*[-*][[:space:]]+(.+)$/â€¢ \1/g')
          
          # 3) í—¤ë”©: ### Title â†’ *Title*  (Slackì€ í—¤ë”© ë¬¸ë²• ì—†ìŒ â†’ ë³¼ë“œë¡œ ëŒ€ì²´)
          BODY_SLACK=$(printf "%s" "$BODY_SLACK" | sed -E 's/^(#{1,6})[[:space:]]*(.+)$/*\2*/g')
          
          # 4) ë§í¬: [text](url) â†’ <url|text>
          BODY_SLACK=$(printf "%s" "$BODY_SLACK" | sed -E 's/\[([^\]]+)\]\((https?:[^)]+)\)/<\2|\1>/g')
          
          # 5) ë³¼ë“œ: **text** â†’ *text*
          BODY_SLACK=$(printf "%s" "$BODY_SLACK" | sed -E 's/\*\*([^*]+)\*\*/*\1*/g')
          
          # 6) ì´ë¯¸ì§€: ![alt](url) â†’ <url>
          BODY_SLACK=$(printf "%s" "$BODY_SLACK" | sed -E 's/!\[[^]]*\]\((https?:[^)]+)\)/<\1>/g')
          
          # 7) íƒ­ â†’ ê³µë°±
          BODY_SLACK=$(printf "%s" "$BODY_SLACK" | sed -E 's/\t/    /g')

          # ë²ˆí˜¸ í‘œê¸°
          NUM_FIELD=""
          if [ -n "${NUMBER}" ]; then
            NUM_FIELD="*Number:* #${NUMBER}\n"
          fi

          # Slack Block Kit payload ì‘ì„± (jqë¡œ ì•ˆì „í•˜ê²Œ)
          jq -n \
          --arg channel  "$CHANNEL" \
          --arg title     "$TITLE_RAW â€” $TITLE" \
          --arg actor     "$ACTOR" \
          --arg eventname "$EVENT_NAME" \
          --arg action    "$ACTION" \
          --arg url       "$URL" \
          --arg repo      "$REPO" \
          --arg number    "$NUMBER" \
          --arg summary   "$TITLE_RAW" \
          --arg body      "$BODY_SLACK" \
          --arg run_url   "$GITHUB_RUN_URL" \
          --arg run_id    "$RUN_ID" \
          --arg color     "$COLOR" \
          --arg date      "$DATE" '
          def field(x): {"type":"mrkdwn","text":x};
    
          {
            channel: $channel,
            attachments: [
              {
                color: $color,
                blocks: (
                  [
                    {"type":"header","text":{"type":"plain_text","text":$title,"emoji":true}},
                    {"type":"section","text":{"type":"mrkdwn","text":"\($body)"}},
                    {"type":"section","fields":[
                      field("*ì‘ì„±ì:*\n\($actor)"),
                      (if $number != "" then field("*ë²ˆí˜¸:*\n#\($number)") else empty end)
                    ]},
                    {"type":"actions","elements":[
                      {"type":"button","text":{"type":"plain_text","text":"Open in GitHub"},"url":$url}
                    ]},
                    {"type":"context","elements":[
                      {"type":"mrkdwn","text":"Run: <\($run_url)|#\($run_id)> â€¢ \($date)"}
                    ]}
                  ] | map(select(. != null))
                )
              }
            ]
          }' > payload.json

      - name: Send to Slack via chat.postMessage (Bot Token)
        run: |
          set -euo pipefail
          RESP=$(curl -sS -X POST "https://slack.com/api/chat.postMessage" \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/json; charset=utf-8" \
            --data @payload.json)

          echo "$RESP" | jq .
          echo "$RESP" | jq -e '.ok == true' >/dev/null || {
            echo "Slack API error: $(echo "$RESP" | jq -r '.error // "unknown_error"')"
            exit 1
          }
