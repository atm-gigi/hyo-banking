name: Slack Notifications (Issues/PRs/Releases)

on:
  workflow_dispatch:
    inputs:
      test_message:
        description: 'Send a test message to Slack'
        required: false
        default: 'Manual test from workflow_dispatch'
  issues:
    types: [opened, edited, closed, reopened, assigned, labeled, unlabeled]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, ready_for_review, review_requested, closed, reopened, converted_to_draft, synchronize]
  release:
    types: [published]

permissions:
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    # ë…¸ì´ì¦ˆ ì¤„ì´ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ì²˜ëŸ¼ ì¡°ê±´ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš” (ì˜ˆ: ë¼ë²¨ ì—†ì„ ë•Œë§Œ ì „ì†¡)
    # if: ${{ github.event_name != 'issues' || !contains(join(github.event.issue.labels.*.name, ','), 'no-slack') }}

    steps:
      - name: Build Slack payload (Block Kit)
        id: payload
        env:
          EVENT_PATH: ${{ github.event_path }}
          GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          TEST_MESSAGE: ${{ inputs.test_message }}
        run: |
          set -euo pipefail
          # ê³µí†µ ì»¨í…ìŠ¤íŠ¸ ì¶”ì¶œ
          REPO="$(jq -r '.repository.full_name' "$EVENT_PATH")"
          ACTOR="${GITHUB_ACTOR}"
          EVENT_NAME="${GITHUB_EVENT_NAME}"
          ACTION="$(jq -r '.action // empty' "$EVENT_PATH")"

          # URL/ì œëª©/ë³¸ë¬¸/ë²ˆí˜¸/ë¨¸ì§€ì—¬ë¶€ ë“± ì¶”ì¶œ
          URL=$(jq -r '.issue.html_url // .pull_request.html_url // .release.html_url // .comment.html_url // .repository.html_url' "$EVENT_PATH")
          NUMBER=$(jq -r '.issue.number // .pull_request.number // empty' "$EVENT_PATH")
          TITLE_RAW=$(jq -r '.issue.title // .pull_request.title // .release.name // empty' "$EVENT_PATH")
          BODY_RAW=$(jq -r '.issue.body // .pull_request.body // .release.body // .comment.body // empty' "$EVENT_PATH")
          BODY_TRUNC=$(printf "%s" "$BODY_RAW" | head -c 500)

          MERGED=$(jq -r '.pull_request.merged // false' "$EVENT_PATH")

          # ì´ë²¤íŠ¸ë³„ íƒ€ì´í‹€/ì´ëª¨ì§€/ìƒ‰ìƒ
          TITLE=""
          COLOR="#dddddd"
          case "${EVENT_NAME}/${ACTION}" in
            issues/opened)              TITLE="ğŸ†• ì´ìŠˆ ì—´ë¦¼" ; COLOR="#36a64f" ;;
            issues/closed)              TITLE="âœ… ì´ìŠˆ ë‹«í˜" ; COLOR="#aaaaaa" ;;
            issues/reopened)            TITLE="â™»ï¸ ì´ìŠˆ ë‹¤ì‹œ ì—´ë¦¼" ; COLOR="#e3b341" ;;
            pull_request/opened)        TITLE="ğŸ“£ í’€ ë¦¬í€˜ìŠ¤íŠ¸ ìš”ì²­" ; COLOR="#439FE0" ;;
            pull_request/ready_for_review) TITLE="ğŸš€ í’€ ë¦¬í€˜ìŠ¤íŠ¸ ë¦¬ë·° ìš”ì²­ ì¤€ë¹„ë¨" ; COLOR="#439FE0" ;;
            pull_request/converted_to_draft) TITLE="ğŸ“ í’€ ë¦¬í€˜ìŠ¤íŠ¸ ì´ˆì•ˆìœ¼ë¡œ ë³€ê²½" ; COLOR="#aaaaaa" ;;
            pull_request/closed)
              if [ "$MERGED" = "true" ]; then
                TITLE="ğŸ‰ í’€ ë¦¬í€˜ìŠ¤íŠ¸ ë¨¸ì§€ë¨" ; COLOR="#6f42c1"
              else
                TITLE="â›”ï¸ í’€ ë¦¬í€˜ìŠ¤íŠ¸ ì·¨ì†Œ" ; COLOR="#aaaaaa"
              fi
              ;;
            pull_request/synchronize)   TITLE="ğŸ”„ í’€ ë¦¬í€˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸" ; COLOR="#439FE0" ;;
            release/published)          TITLE="ğŸ·ï¸ ë¦´ë¦¬ì¦ˆ ë°°í¬" ; COLOR="#2eb67d" ;;
            issue_comment/created)      TITLE="ğŸ’¬ ìƒˆë¡œìš´ ëŒ“ê¸€" ; COLOR="#4a154b" ;;
            */)
              # workflow_dispatch ë“±
              TITLE="â„¹ï¸ GitHub notification"
              ;;
            *)
              TITLE="â„¹ï¸ ${EVENT_NAME} (${ACTION})"
              ;;
          esac

          # ìˆ˜ë™ ì‹¤í–‰ ì‹œ í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì§€ì›
          if [ "${EVENT_NAME}" = "workflow_dispatch" ]; then
            BODY_TRUNC="${TEST_MESSAGE}"
            URL="https://github.com/${{ github.repository }}"
          fi

          # ë³¸ë¬¸ ì—†ìœ¼ë©´ ëŒ€ì²´ë¬¸êµ¬
          if [ -z "${BODY_TRUNC}" ]; then
            BODY_TRUNC="(no description)"
          fi

          # ë²ˆí˜¸ í‘œê¸°
          NUM_FIELD=""
          if [ -n "${NUMBER}" ]; then
            NUM_FIELD="*Number:* #${NUMBER}\n"
          fi

          # Slack Block Kit payload ì‘ì„± (jqë¡œ ì•ˆì „í•˜ê²Œ)
          jq -n \
            --arg title        "$TITLE â€” $REPO" \
            --arg actor        "$ACTOR" \
            --arg eventname    "$EVENT_NAME" \
            --arg action       "$ACTION" \
            --arg url          "$URL" \
            --arg repo         "$REPO" \
            --arg numberField  "$NUM_FIELD" \
            --arg summary      "$TITLE_RAW" \
            --arg body         "$BODY_TRUNC" \
            --arg run_url      "$GITHUB_RUN_URL" \
            --arg color        "$COLOR" \
            '{
              attachments: [
                {
                  color: $color,
                  blocks: [
                    { "type": "header", "text": { "type": "plain_text", "text": $title, "emoji": true } },
                    { "type": "section",
                      "fields": [
                        { "type": "mrkdwn", "text": "*Actor:*\n" + $actor },
                        { "type": "mrkdwn", "text": "*Event:*\n" + $eventname + (if $action != "" then "/" + $action else "" end) },
                        { "type": "mrkdwn", "text": "*Repo:*\n" + $repo },
                        (if $numberField != "" then { "type": "mrkdwn", "text": $numberField } else empty end)
                      ]
                    },
                    (if $summary != "" then { "type": "section", "text": { "type": "mrkdwn", "text": "*Title:*\n" + $summary } } else empty end),
                    { "type": "section", "text": { "type": "mrkdwn", "text": "*Description:*\n" + $body } },
                    { "type": "actions",
                      "elements": [
                        { "type": "button", "text": { "type": "plain_text", "text": "Open in GitHub" }, "url": $url }
                      ]
                    },
                    { "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": "Run: <" + $run_url + "|#${{ github.run_id }}> â€¢ $(date +%Y-%m-%d)" }
                      ]
                    }
                  ]
                }
              ]
            }' > payload.json

      - name: Send to Slack via Incoming Webhook
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          set -euo pipefail
          curl -s -X POST -H 'Content-type: application/json' --data @payload.json "$SLACK_WEBHOOK_URL" >/dev/null
